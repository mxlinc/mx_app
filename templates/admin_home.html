<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Home - Assign Work</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* Make only first column selectable */
        .copy-only-first td {
            user-select: none;
        }

        .copy-only-first td:first-child {
            user-select: text;
            white-space: nowrap;
            cursor: text;
        }

        /* Set card width to 90% and center */
        .card {
            width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
    </style>


</head>

<body class="bg-light">

    <!-- ✅ Create Work Package  -->
    <div class="card shadow p-3 mb-4">
        <h5 class="card-title mb-3">Create Work Package</h5>
        <form method="POST" action="{{ url_for('create_pack') }}">
            <div class="row mb-2">
                <div class="col-md-3">
                    <input type="number" name="pack_id" class="form-control" placeholder="Enter Pack ID" required>
                </div>
                <div class="col-md-4">
                    <input type="text" name="pack_desc" class="form-control" placeholder="Package Description" required>
                </div>
                <div class="col-md-4">
                    <select id="broad_area_select" name="broad_area_select" class="form-select" required
                        onchange="toggleBroadAreaInput(this.value)">
                        <option value="" disabled selected>Select Broad Area</option>
                        {% for area in broad_areas %}
                        <option value="{{ area }}">{{ area }}</option>
                        {% endfor %}
                        <option value="__new__">Enter New?</option>
                    </select>
                    <input type="text" id="broad_area_input" name="broad_area" class="form-control mt-2 d-none"
                        placeholder="Enter New Broad Area">
                </div>
            </div>
            <div class="mb-3">
                <textarea name="work_ids" rows="5" class="form-control"
                    placeholder="Paste work IDs (old or numeric, one per line)" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">Create Package</button>
        </form>
    </div>
    <!--  Broad Area Input -->
    <script>
        function toggleBroadAreaInput(val) {
            const input = document.getElementById("broad_area_input");
            if (val === "__new__") {
                input.classList.remove("d-none");
                input.required = true;
            } else {
                input.classList.add("d-none");
                input.required = false;
            }
        }
    </script>


    <!-- ✅ Recent Packages Section -->
    <div id="recent-packs" class="card shadow p-3">
        <h5 class="card-title">Recent Packages</h5>
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>Pack ID</th>
                    <th>Broad Area</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for p in recent_packs %}
                <tr>
                    <td><a href="#" onclick="showPackDetails({{ p.pack_id }})">{{ p.pack_id }}</a></td>
                    <td>{{ p.broad_area }}</td>
                    <td>{{ p.pack_desc }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Modal for Pack Details -->
    <div class="modal fade" id="packDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Works in this pack:</strong>
                    </div>
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Work ID</th>
                                <th>Work Name</th>
                            </tr>
                        </thead>
                        <tbody id="modalWorkRows"></tbody>
                    </table>
                    <div class="mb-3 mt-3">
                        <label for="workIdsTextarea" class="form-label">Pastable Work IDs:</label>
                        <textarea id="workIdsTextarea" class="form-control" rows="4" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentWorkIds = [];

        function showPackDetails(packId) {
            fetch(`/packdetails/${packId}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("modalTitle").innerText = `Pack ${data.pack_id}: ${data.pack_desc}`;
                    let rows = "";
                    currentWorkIds = [];
                    data.works.forEach(w => {
                        currentWorkIds.push(w.work_id);
                        rows += `
      <tr>
        <td style="user-select: text; white-space: nowrap;">${w.work_id}</td>
        <td><a href="${w.work_link}" target="_blank">${w.work_name}</a></td>
      </tr>`;
                    });
                    document.getElementById("modalWorkRows").innerHTML = rows;
                    document.getElementById("workIdsTextarea").value = currentWorkIds.join('\n');
                    new bootstrap.Modal(document.getElementById("packDetailsModal")).show();
                });
        }
    </script>


    <!-- ✅ Work Assignment Card -->

    <div class="container mt-4">

        <div class="card shadow p-3 mb-4">
            <h5 class="card-title mb-3">Assign Work Package</h5>
            <form id="assignForm" class="row g-2" onsubmit="submitAssign(event)">
                <div class="col-md-4">
                    <select name="student" class="form-select" id="assign-student" required>
                        <option value="" disabled selected>Select Student</option>
                        {% for student in students %}
                        <option value="{{ student.username }}">{{ student.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" name="package_id" id="assign-pack" class="form-control"
                        placeholder="Enter Package ID" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Assign</button>
                </div>
            </form>
        </div>

        <script>
            function submitAssign(event) {
                event.preventDefault();

                const form = event.target;
                const student = document.getElementById("assign-student").value;
                const packId = document.getElementById("assign-pack").value;
                const submitBtn = form.querySelector("button[type='submit']");

                submitBtn.disabled = true;

                fetch("/assignwork", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ student, package_id: packId })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.conflict) {
                            showConflictModal(data.student, data.pack_id, data.conflict_items);

                        } else {
                            alert(data.message);
                            location.reload();
                        }
                    })
                    .catch(err => {
                        alert("Something went wrong: " + err.message);
                        console.error(err);
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                    });
            }


            function forceAssign(student, packId) {
                fetch("/assignwork", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ student, package_id: packId, force: "true" })
                })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message);
                        location.reload();
                    });
            }

            function showConflictModal(student, packId, conflictIds) {
                document.getElementById("conflict-student").textContent = student;
                document.getElementById("conflict-pack").textContent = packId;
                document.getElementById("conflict-list").innerHTML = conflictIds
                    .map(item => `<li><strong>${item.id}</strong> - ${item.name}</li>`)
                    .join("");

                document.getElementById("modal-yes-btn").onclick = () => forceAssign(student, packId);
                new bootstrap.Modal(document.getElementById("conflictModal")).show();
            }
        </script>

        <div class="modal fade" id="conflictModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">⚠️ Conflict Detected</h5>
                    </div>
                    <div class="modal-body">
                        <p>The following work IDs already exist for <strong><span id="conflict-student"></span></strong>
                            in
                            other packages:</p>
                        <ul id="conflict-list"></ul>
                        <p>Do you still want to assign <strong>pack <span id="conflict-pack"></span></strong> to them?
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌ No, Cancel</button>
                        <button id="modal-yes-btn" type="button" class="btn btn-primary">✅ Yes, Assign Anyway</button>
                    </div>
                </div>
            </div>
        </div>


</body>

</html>