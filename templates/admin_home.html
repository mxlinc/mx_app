<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin Home - Assign Work</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .copy-only-first td {
      user-select: none;
    }

    .copy-only-first td:first-child {
      user-select: text;
      white-space: nowrap;
      cursor: text;
    }

    .card {
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      max-width: none;
    }

    .container {
      max-width: none !important;
      width: 100% !important;
      padding-left: 32px;
      padding-right: 32px;
    }

    #recent-packs {
      width: 100% !important;
      margin-left: auto;
      margin-right: auto;
      max-width: none;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container mt-4">
    <!-- Navigation buttons -->
    <div class="d-flex justify-content-start mb-4">
      <a href="{{ url_for('admin_home') }}" class="btn btn-outline-primary fw-bold px-4 me-2">Admin Home</a>
      <a href="{{ url_for('pack_report') }}" class="btn btn-outline-secondary fw-bold px-4 me-2">Packages</a>
      <a href="{{ url_for('fine_tune') }}" class="btn btn-outline-success fw-bold px-4">Fine Tune</a>
    </div>

    <!-- Create Work Package -->
    <div class="card shadow p-3 mb-4">
      <h5 class="card-title mb-3">Create Work Package</h5>
      <form id="create-pack-form" method="POST" action="{{ url_for('create_pack') }}">
        <div class="row align-items-center g-2">
          <div class="col-md-2">
            <input type="number" name="pack_id" class="form-control" placeholder="Pack ID" required />
          </div>
          <div class="col-md-2">
            <input type="text" name="pack_desc" class="form-control" placeholder="Description" required />
          </div>
          <div class="col-md-2">
            <select id="broad_area_select" name="broad_area_select" class="form-select" required
              onchange="toggleBroadAreaInput(this.value)">
              <option value="" disabled selected>Broad Area</option>
              {% for area in broad_areas %}
              <option value="{{ area }}">{{ area }}</option>
              {% endfor %}
              <option value="__new__">Enter New?</option>
            </select>
            <input type="text" id="broad_area_input" name="broad_area" class="form-control mt-2 d-none"
              placeholder="New Broad Area" />
          </div>
          <div class="col-md-4">
            <textarea name="work_ids" rows="1" class="form-control" placeholder="Paste work IDs, one per line"
              required></textarea>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Create/Update Package</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Recent Packages -->
    <div id="recent-packs" class="card shadow p-3 mb-4">
      <h5 class="card-title">Recent Packages</h5>
      <div class="row mb-3">
        <div class="col-md-4">
          <select id="filter-area" class="form-select" onchange="filterPackages()">
            <option value="__all__">All Broad Areas</option>
            {% for area in broad_areas %}
            <option value="{{ area }}">{{ area }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4 d-flex">
          <select id="filter-student" class="form-select me-2" multiple size="6">
            {% for student in students|sort(attribute='full_name') %}
            <option value="{{ student.username }}">{{ student.full_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <table class="table table-sm table-hover" id="recent-packs-table">
        <thead>
          <tr>
            <th>Pack ID</th>
            <th>Broad Area</th>
            <th>Description</th>
            <th>Assign</th>
          </tr>
        </thead>
        <tbody>
          {% for p in recent_packs %}
          <tr data-area="{{ p.broad_area }}">
            <td>
              <a href="javascript:void(0);" onclick="showPackDetails({{ p.pack_id }})">{{ p.pack_id }}</a>
            </td>
            <td>{{ p.broad_area }}</td>
            <td>{{ p.pack_desc }}</td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-primary"
                onclick="assignPackToStudent('{{ p.pack_id }}', '{{ p.broad_area }}')">
                Assign to Student
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-center mb-4">
      <a href="/fine_tune" class="btn btn-outline-primary fw-bold px-5 py-3" style="font-size:1.25rem;">
        Fine Tune
      </a>
    </div>
  </div>

  <script>
    function toggleBroadAreaInput(val) {
      const input = document.getElementById("broad_area_input");
      if (val === "__new__") { input.classList.remove("d-none"); input.required = true; }
      else { input.classList.add("d-none"); input.required = false; }
    }

    function filterPackages() {
      const selectedArea = document.getElementById("filter-area").value;
      const rows = document.querySelectorAll("#recent-packs-table tbody tr");
      rows.forEach(row => {
        row.style.display = (selectedArea === "__all__" || row.getAttribute("data-area") === selectedArea) ? "" : "none";
      });
    }

    function assignPackToStudent(packId) {
      const studentSelect = document.getElementById("filter-student");
      const selectedStudents = Array.from(studentSelect.selectedOptions).map(opt => opt.value);
      if (selectedStudents.length === 0) { alert("Please select at least one student."); return; }

      const params = new URLSearchParams();
      selectedStudents.forEach(s => params.append("student", s));
      params.append("package_id", packId);

      fetch("/assignwork", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params
      })
        .then(res => res.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            let pending = [];
            data.results.forEach(res => {
              if (res.conflict && !res.can_assign) {
                // Show conflict modal for this student
                pending.push(res);
              } else {
                alert(res.message);
              }
            });
            // If there are pending confirmations, show them one by one
            if (pending.length > 0) {
              handleNextConfirmation(pending, packId);
            } else {
              location.reload();
            }
          }
        })
        .catch(err => {
          alert("Something went wrong: " + err.message);
          console.error(err);
        });
    }

    function goFineTune() {
      const student = document.getElementById("filter-student").value;
      if (!student) { alert("Please select a student first."); return; }
      window.location.href = `/fine_tune?student=${encodeURIComponent(student)}`;
    }

    document.getElementById('create-pack-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const packId = form.pack_id.value;
      fetch(`/check_pack_id/${packId}`)
        .then(res => res.json())
        .then(data => {
          if (data.exists) {
            // Show modal
            document.getElementById('modal-pack-id').textContent = packId;
            const modal = new bootstrap.Modal(document.getElementById('confirmUpdateModal'));
            modal.show();
            document.getElementById('modal-update-btn').onclick = function() {
              modal.hide();
              form.submit();
            };
          } else {
            form.submit();
          }
        });
    });

    function handleNextConfirmation(pendingList, packId) {
  if (pendingList.length === 0) {
    location.reload();
    return;
  }
  const res = pendingList.shift();
  showConflictModal(res.student, packId, res.conflict_items, function(confirmed) {
    if (confirmed) {
      // Assign with force for this student
      const params = new URLSearchParams();
      params.append("student", res.student);
      params.append("package_id", packId);
      params.append("force", "true");
      fetch("/assignwork", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params
      })
      .then(r => r.json())
      .then(data => {
        alert(data.results[0].message);
        handleNextConfirmation(pendingList, packId);
      });
    } else {
      handleNextConfirmation(pendingList, packId);
    }
  });
}

function showConflictModal(student, packId, conflictItems, callback) {
  document.getElementById("conflict-student").textContent = student;
  document.getElementById("conflict-pack").textContent = packId;
  const list = document.getElementById("conflict-list");
  list.innerHTML = "";
  conflictItems.forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.id}: ${item.name}`;
    list.appendChild(li);
  });
  const modal = new bootstrap.Modal(document.getElementById("conflictModal"));
  modal.show();
  document.getElementById("modal-yes-btn").onclick = function() {
    modal.hide();
    callback(true);
  };
  document.querySelector("#conflictModal .btn-secondary").onclick = function() {
    modal.hide();
    callback(false);
  };
}
  </script>

  <!-- Pack details modal -->
  <div class="modal fade" id="packDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between mb-2">
            <strong>Works in this pack:</strong>
          </div>
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>Work ID</th>
                <th>Work Name</th>
              </tr>
            </thead>
            <tbody id="modalWorkRows"></tbody>
          </table>
          <div class="mb-3 mt-3">
            <label for="workIdsTextarea" class="form-label">Edit Work IDs (one per line):</label>
            <textarea id="workIdsTextarea" class="form-control" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button id="updatePackBtn" type="button" class="btn btn-success">Update</button>
        </div>
      </div>
    </div>
  </div>

  <script>
let currentPackId = null;
let currentWorkIds = [];

function showPackDetails(packId) {
  fetch(`/packdetails/${packId}`)
    .then(res => res.json())
    .then(data => {
      currentPackId = data.pack_id;
      document.getElementById("modalTitle").innerText = `Pack ${data.pack_id}: ${data.pack_desc}`;
      let rows = "";
      currentWorkIds = [];
      data.works.forEach(w => {
        currentWorkIds.push(w.work_id);
        rows += `
          <tr>
            <td style="user-select: text; white-space: nowrap;">${w.work_id}</td>
            <td><a href="${w.work_link}" target="_blank">${w.work_name}</a></td>
          </tr>`;
      });
      document.getElementById("modalWorkRows").innerHTML = rows;
      document.getElementById("workIdsTextarea").value = currentWorkIds.join('\n');
      new bootstrap.Modal(document.getElementById("packDetailsModal")).show();
    });
}

// Handle update button click
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById("updatePackBtn").onclick = function() {
    const newWorkIds = document.getElementById("workIdsTextarea").value
      .split('\n')
      .map(x => x.trim())
      .filter(x => x.length > 0);
    if (!currentPackId || newWorkIds.length === 0) {
      alert("Pack ID or work IDs missing.");
      return;
    }
    fetch('/update_pack_works/' + currentPackId, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ work_ids: newWorkIds })
    })
    .then(res => {
      if (res.ok) {
        // Hide modal and reload admin page
        bootstrap.Modal.getInstance(document.getElementById("packDetailsModal")).hide();
        window.location.reload();
      } else {
        res.text().then(msg => alert(msg));
      }
    });
  };
});
  </script>

  <!-- Conflict modal -->
  <div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">⚠️ Conflict Detected</h5>
        </div>
        <div class="modal-body">
          <p>The following work IDs already exist for <strong><span id="conflict-student"></span></strong> in other
            packages:</p>
          <ul id="conflict-list"></ul>
          <p>Do you still want to assign <strong>pack <span id="conflict-pack"></span></strong> to them?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌ No, Cancel</button>
          <button id="modal-yes-btn" type="button" class="btn btn-primary">✅ Yes, Assign Anyway</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for confirming update of existing package -->
  <div class="modal fade" id="confirmUpdateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Existing Package?</h5>
        </div>
        <div class="modal-body">
          <p>Pack ID <strong id="modal-pack-id"></strong> already exists.<br>
          Do you want to update this package?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="modal-update-btn" type="button" class="btn btn-primary">Update Package</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>