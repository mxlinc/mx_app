<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin Home - Assign Work</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .copy-only-first td {
      user-select: none;
    }

    .copy-only-first td:first-child {
      user-select: text;
      white-space: nowrap;
      cursor: text;
    }

    .card {
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      max-width: none;
    }

    .container {
      max-width: none !important;
      width: 100% !important;
      padding-left: 32px;
      padding-right: 32px;
    }

    #recent-packs {
      width: 100% !important;
      margin-left: auto;
      margin-right: auto;
      max-width: none;
    }

    /* Add these new styles for color coding */
    .video-work {
      color: maroon;
      font-weight: bold;
    }

    .worksheet-work {
      color: darkgreen;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container mt-4">
    <!-- Navigation buttons -->
    <div class="d-flex justify-content-start mb-4">
      <a href="{{ url_for('admin_home') }}" class="btn btn-outline-primary fw-bold px-4 me-2">Admin Home</a>
      <a href="{{ url_for('pack_report') }}" class="btn btn-outline-secondary fw-bold px-4 me-2">Packages</a>
      <a href="{{ url_for('fine_tune') }}" class="btn btn-outline-success fw-bold px-4">Fine Tune</a>
    </div>

    <!-- Create Work Package -->
    <div class="card shadow p-3 mb-4">
      <h5 class="card-title mb-3">Create Work Package</h5>
      <form id="create-pack-form" method="POST" action="{{ url_for('create_pack') }}">
        <div class="row align-items-center g-2">
          <div class="col-md-2">
            <input type="text" name="pack_desc" class="form-control" placeholder="Description" required />
          </div>
          <div class="col-md-2">
            <select id="broad_area_select" name="broad_area_select" class="form-select" required
              onchange="toggleBroadAreaInput(this.value)">
              <option value="" disabled selected>Broad Area</option>
              {% for area in broad_areas %}
              <option value="{{ area }}">{{ area }}</option>
              {% endfor %}
              <option value="__new__">Enter New?</option>
            </select>
            <input type="text" id="broad_area_input" name="broad_area" class="form-control mt-2 d-none"
              placeholder="New Broad Area" />
          </div>
          <div class="col-md-4">
            <textarea name="work_ids" rows="1" class="form-control" placeholder="Paste work IDs, one per line"
              required></textarea>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Create Package</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Bulk Assignment Panel -->
    <div class="card shadow p-3 mb-4">
      <form id="bulk-assign-form">
        <div class="row mb-3">
          <div class="col-12">
            <div class="row" style="border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
              {% for student in students|sort(attribute='full_name') %}
              <div class="col-md-2 col-sm-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="{{ student.username }}"
                    id="bulk-student-{{ student.username }}">
                  <label class="form-check-label" for="bulk-student-{{ student.username }}"
                    style="font-size: 0.85em;">
                    {{ student.full_name }}
                  </label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="row align-items-end">
          <div class="col-md-3">
            <label class="form-label">Pack IDs (comma separated):</label>
            <input type="text" id="bulk-pack-ids" class="form-control" placeholder="1001, 1002, 1003" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-success">Assign Packs</button>
          </div>
        </div>
      </form>
    </div>

    <!-- All Packages -->
    <div id="recent-packs" class="card shadow p-3 mb-4">
      {% set broad_areas_list = all_packs|groupby('broad_area')|list %}
      {% for row_start in range(0, broad_areas_list|length, 4) %}
      <div class="row mb-3">
        {% for col_offset in range(4) %}
          {% set index = row_start + col_offset %}
          {% if index < broad_areas_list|length %}
            {% set area_group = broad_areas_list[index] %}
            <div class="col-md-3">
              <div class="accordion" id="packagesAccordion{{ index }}">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-{{ index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapse-{{ index }}" aria-expanded="false"
                      aria-controls="collapse-{{ index }}"
                      style="font-size: 0.425em; padding: 6px 8px;">
                      {{ area_group.grouper }} ({{ area_group.list|length }})
                    </button>
                  </h2>
                  <div id="collapse-{{ index }}" class="accordion-collapse collapse"
                    aria-labelledby="heading-{{ index }}" data-bs-parent="#packagesAccordion{{ index }}">
                    <div class="accordion-body p-0">
                      <table class="table table-sm table-hover mb-0" style="font-size: 0.75em;">
                        <tbody>
                          {% for pack in area_group.list %}
                          <tr>
                            <td>{{ pack.pack_id }}</td>
                            <td>
                              <a href="javascript:void(0);" onclick="showPackDetails({{ pack.pack_id }})" 
                                 style="text-decoration: none; font-size: 0.75em;">
                                {{ pack.pack_desc }}
                              </a>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endfor %}
    </div>

  </div>

  <!-- Pack details modal -->
  <div class="modal fade" id="packDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between mb-2">
            <strong>Works in this pack:</strong>
          </div>
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>Work ID</th>
                <th>Work Name</th>
              </tr>
            </thead>
            <tbody id="modalWorkRows"></tbody>
          </table>
          <div class="mb-3 mt-3">
            <label for="workIdsTextarea" class="form-label">Edit Work IDs (one per line):</label>
            <textarea id="workIdsTextarea" class="form-control" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button id="updatePackBtn" type="button" class="btn btn-success">Update</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conflict modal -->
  <div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚ö†Ô∏è Conflict Detected</h5>
        </div>
        <div class="modal-body">
          <p>The following work IDs already exist for <strong><span id="conflict-student"></span></strong> in other
            packages:</p>
          <ul id="conflict-list"></ul>
          <p>Do you still want to assign <strong>pack <span id="conflict-pack"></span></strong> to them?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå No, Cancel</button>
          <button id="modal-yes-btn" type="button" class="btn btn-primary">‚úÖ Yes, Assign Anyway</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conflict Resolution Modal -->
  <div class="modal fade" id="conflictResolutionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚ö†Ô∏è Assignment Conflicts Detected</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">The following works are already assigned to students under different packs:</p>
          <div id="conflict-resolution-content"></div>
          <hr class="my-3">
          <p class="mb-0"><strong>Choose how to handle these conflicts:</strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="processAssignments('normal')" data-bs-dismiss="modal">
            ‚ùå Abort
          </button>
          <button type="button" class="btn btn-warning" onclick="processAssignments('reject_dupes')">
            üö´ Reject Dupes
          </button>
          <button type="button" class="btn btn-success" onclick="processAssignments('accept_dupes')">
            ‚úÖ Accept Dupes as Past
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
function toggleBroadAreaInput(val) {
  const input = document.getElementById("broad_area_input");
  if (val === "__new__") { 
    input.classList.remove("d-none"); 
    input.required = true; 
  } else { 
    input.classList.add("d-none"); 
    input.required = false; 
  }
}

// Bulk assignment functionality
let allConflicts = [];
let assignmentData = {};

document.getElementById('bulk-assign-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const selectedStudents = [];
  document.querySelectorAll('input[id^="bulk-student-"]:checked').forEach(cb => {
    selectedStudents.push(cb.value);
  });
  
  if (selectedStudents.length === 0) {
    alert('Please select at least one student.');
    return;
  }
  
  const packIdsInput = document.getElementById('bulk-pack-ids').value.trim();
  if (!packIdsInput) {
    alert('Please enter pack IDs.');
    return;
  }
  
  const packIds = packIdsInput.split(',').map(id => id.trim()).filter(id => id);
  if (packIds.length === 0) {
    alert('Please enter valid pack IDs.');
    return;
  }

  // Store assignment data for later use
  assignmentData = {
    students: selectedStudents,
    packIds: packIds
  };

  // Check conflicts for all student-pack combinations
  checkAllConflicts(selectedStudents, packIds);
});

function checkAllConflicts(students, packIds) {
  allConflicts = [];
  let completedChecks = 0;
  let totalChecks = students.length * packIds.length;

  students.forEach(student => {
    packIds.forEach(packId => {
      // Check conflicts for this student-pack combination
      fetch('/check_assignment_conflicts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          student: student, 
          pack_id: packId 
        })
      })
      .then(res => res.json())
      .then(data => {
        completedChecks++;
        
        if (data.conflicts && data.conflicts.length > 0) {
          data.conflicts.forEach(conflict => {
            allConflicts.push({
              student: student,
              packId: packId,
              workId: conflict.work_id,
              workName: conflict.work_name,
              existingPackId: conflict.existing_pack_id
            });
          });
        }

        // When all checks are complete, show results
        if (completedChecks === totalChecks) {
          if (allConflicts.length > 0) {
            showConflictResolutionModal();
          } else {
            // No conflicts, proceed with assignment
            processAssignments('normal');
          }
        }
      })
      .catch(err => {
        completedChecks++;
        console.error(`Error checking conflicts for ${student}, pack ${packId}:`, err);
        
        if (completedChecks === totalChecks) {
          alert('Error checking conflicts. Please try again.');
        }
      });
    });
  });
}

function showConflictResolutionModal() {
  // Group conflicts by student for display
  const conflictsByStudent = {};
  allConflicts.forEach(conflict => {
    if (!conflictsByStudent[conflict.student]) {
      conflictsByStudent[conflict.student] = [];
    }
    conflictsByStudent[conflict.student].push(conflict);
  });

  // Build conflict list HTML
  let conflictHtml = '<div style="max-height: 400px; overflow-y: auto;">';
  Object.keys(conflictsByStudent).sort().forEach(student => {
    conflictHtml += `<h6 class="mb-2 mt-3"><strong>${student}:</strong></h6>`;
    conflictsByStudent[student].forEach(conflict => {
      conflictHtml += `
        <div class="ms-3 mb-1">
          Pack ${conflict.packId} ‚Üí Work ${conflict.workId} (${conflict.workName}) 
          <small class="text-muted">already in Pack ${conflict.existingPackId}</small>
        </div>`;
    });
  });
  conflictHtml += '</div>';

  // Update modal content
  document.getElementById('conflict-resolution-content').innerHTML = conflictHtml;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('conflictResolutionModal'));
  modal.show();
}

function processAssignments(mode) {
  // Close any open modals
  const modalElement = document.getElementById('conflictResolutionModal');
  if (modalElement) {
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) modal.hide();
  }

  const { students, packIds } = assignmentData;
  
  let completedAssignments = 0;
  let totalAssignments = students.length * packIds.length;
  let results = [];

  students.forEach(student => {
    packIds.forEach(packId => {
      const params = new URLSearchParams();
      params.append('student', student);
      params.append('package_id', packId);
      params.append('assignment_mode', mode); // 'normal', 'accept_dupes', 'reject_dupes'
      
      // Include conflict data if needed
      if (mode !== 'normal') {
        const studentConflicts = allConflicts.filter(c => 
          c.student === student && c.packId == packId
        );
        params.append('conflicts', JSON.stringify(studentConflicts));
      }

      fetch('/process_assignment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      })
      .then(res => res.json())
      .then(data => {
        completedAssignments++;
        results.push(data);

        if (completedAssignments === totalAssignments) {
          // Show final results
          const successCount = results.filter(r => r.success).length;
          const errorCount = results.length - successCount;
          
          if (errorCount > 0) {
            alert(`Assignment completed with ${successCount} successes and ${errorCount} errors. Check console for details.`);
            console.log('Assignment results:', results);
          } else {
            alert(`Successfully processed ${totalAssignments} assignments!`);
          }
          
          document.getElementById('bulk-assign-form').reset();
          location.reload();
        }
      })
      .catch(err => {
        completedAssignments++;
        console.error(`Error processing assignment for ${student}, pack ${packId}:`, err);
        
        if (completedAssignments === totalAssignments) {
          alert('Some assignments failed. Check console for details.');
          location.reload();
        }
      });
    });
  });
}

// Pack details functionality
let currentPackId = null;
let currentWorkIds = [];

function showPackDetails(packId) {
  fetch(`/packdetails/${packId}`)
    .then(res => res.json())
    .then((data) => {
      currentPackId = data.pack_id;
      document.getElementById("modalTitle").innerText = `Pack ${data.pack_id}: ${data.pack_desc}`;
      let rows = "";
      currentWorkIds = [];
      data.works.forEach(w => {
        currentWorkIds.push(w.work_id);
        
        let workNameHtml = w.work_name;
        if (w.work_name.startsWith('V-')) {
          workNameHtml = `<span class="video-work">${w.work_name}</span>`;
        } else if (w.work_name.startsWith('W-')) {
          workNameHtml = `<span class="worksheet-work">${w.work_name}</span>`;
        }
        
        rows += `
          <tr>
            <td style="user-select: text; white-space: nowrap;">${w.work_id}</td>
            <td><a href="${w.work_link}" target="_blank">${workNameHtml}</a></td>
          </tr>`;
      });
      document.getElementById("modalWorkRows").innerHTML = rows;
      document.getElementById("workIdsTextarea").value = currentWorkIds.join('\n');
      new bootstrap.Modal(document.getElementById("packDetailsModal")).show();
    });
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById("updatePackBtn").onclick = function() {
    const newWorkIds = document.getElementById("workIdsTextarea").value
      .split('\n')
      .map(x => x.trim())
      .filter(x => x.length > 0);
    if (!currentPackId || newWorkIds.length === 0) {
      alert("Pack ID or work IDs missing.");
      return;
    }
    fetch('/update_pack_works/' + currentPackId, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ work_ids: newWorkIds })
    })
    .then(res => {
      if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById("packDetailsModal")).hide();
        window.location.reload();
      } else {
        res.text().then(msg => alert(msg));
      }
    });
  };
});
  </script>
</body>

</html>