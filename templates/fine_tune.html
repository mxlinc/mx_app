<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fine Tune Assignments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .video-work {
            color: maroon;
            font-weight: bold;
        }
        .worksheet-work {
            color: darkgreen;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="d-flex justify-content-start mb-4">
            <a href="{{ url_for('admin_home') }}" class="btn btn-outline-primary fw-bold px-4 me-2">Admin Home</a>
            <a href="{{ url_for('pack_report') }}" class="btn btn-outline-secondary fw-bold px-4 me-2">Packages</a>
            <a href="{{ url_for('fine_tune') }}" class="btn btn-outline-success fw-bold px-4">Fine Tune</a>
        </div>
        
        <div class="card shadow p-3 mb-4">
            <h4 class="card-title mb-3">Fine tune work for student</h4>
            <form id="filterForm" method="get" autocomplete="off">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Student</label>
                        <select name="student" class="form-select">
                            <option value="" disabled {% if not selected_student %}selected{% endif %}>Select Student</option>
                            {% for student in students|sort(attribute='full_name') %}
                            <option value="{{ student.username }}" {% if student.username == selected_student %}selected{% endif %}>{{ student.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-9 d-flex align-items-end">
                        <div class="w-100 d-flex justify-content-between">
                            {% for s in ['Future','Assigned','Done','Past','X-Delete'] %}
                            <div class="form-check flex-fill text-center">
                                <label class="form-check-label" for="status-{{ s }}">
                                    <input class="form-check-input ms-1 me-2" type="checkbox" name="status" value="{{ s }}" id="status-{{ s }}"
                                        {% if s in selected_status %}checked{% endif %}>
                                    {{ s }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </form>
        </div>

        {% if packs and packs|length > 0 %}
        <div class="accordion" id="packsAccordion">
            {% for pack in packs %}
            <div class="accordion-item mb-3">
                <h2 class="accordion-header" id="heading-{{ pack.pack_id }}">
                    <div class="d-flex w-100 align-items-center">
                        <button class="accordion-button flex-grow-1" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ pack.pack_id }}" aria-expanded="true"
                            aria-controls="collapse-{{ pack.pack_id }}">
                            Pack {{ pack.pack_id }}: {{ pack.pack_desc }}
                        </button>
                        <a href="javascript:void(0);" class="btn btn-sm btn-success me-2"
                           onclick="markPackDone('{{ selected_student }}', {{ pack.pack_id }})"
                           title="Mark Pack as Done">
                           D
                        </a>
                    </div>
                </h2>
                <div id="collapse-{{ pack.pack_id }}" class="accordion-collapse collapse show"
                    aria-labelledby="heading-{{ pack.pack_id }}" data-bs-parent="#packsAccordion">
                    <div class="accordion-body">
                        <ul class="list-group">
                            {% for w in pack.works %}
                            <li class="list-group-item d-flex align-items-center" id="work-row-{{ w.work_id }}">
                                <div style="width:48px; text-align:center;">
                                    {% if w.work_status != 'Assigned' %}
                                    <a href="#" class="btn btn-sm {% if w.work_status == 'Done' %}btn-secondary{% else %}btn-primary fw-bold{% endif %}"
                                       title="Assigned"
                                       onclick="updateWorkStatus('{{ w.username }}', '{{ w.pack_id }}', '{{ w.work_id }}', 'Assigned', this); return false;">
                                        A
                                    </a>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 d-flex align-items-center">
                                    <a href="{{ w.work_link }}?SN={{ w.username }}&TITLE={{ w.work_id }}" target="_blank" class="me-2 text-decoration-underline">{{ w.work_id }}</a>
                                    {% if w.work_name.startswith('V-') %}
                                        <span class="video-work">{{ w.work_name }}</span>
                                    {% elif w.work_name.startswith('W-') %}
                                        <span class="worksheet-work">{{ w.work_name }}</span>
                                    {% else %}
                                        {{ w.work_name }}
                                    {% endif %}
                                    {% if w.work_status == 'Future' %}
                                        <span class="badge" style="background: #ffe066; color: #222; font-weight: bold; border: 1px solid #ffec99;">Future</span>
                                    {% else %}
                                        <span class="badge bg-secondary ms-2">{{ w.work_status }}</span>
                                    {% endif %}
                                    {% if w.work_status == 'Done' and w.work_score %}
                                        <span class="badge bg-success ms-2">{{ w.work_score }}</span>
                                    {% endif %}
                                    {% if w.work_views is not none %}
                                        <span class="badge bg-info ms-2">{{ w.work_views }}</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <span style="display:inline-block; width:24px;"></span>
                                    <a href="#" class="btn btn-sm btn-outline-primary ms-1"
                                       title="Future"
                                       onclick="updateWorkStatus('{{ w.username }}', '{{ w.pack_id }}', '{{ w.work_id }}', 'Future', this); return false;">
                                        F
                                    </a>
                                    <a href="#" class="btn btn-sm btn-outline-primary ms-1"
                                       title="Next"
                                       onclick="updateWorkStatus('{{ w.username }}', '{{ w.pack_id }}', '{{ w.work_id }}', 'Next', this); return false;">
                                        N
                                    </a>
                                    <span style="display:inline-block; width:24px;"></span>
                                    {% for code, tip in [('D','Done'),('T','Past'),('R','Defer'),('X','X-Delete')] %}
                                        <a href="#" class="btn btn-sm btn-outline-primary ms-1"
                                           title="{{ tip }}"
                                           onclick="updateWorkStatus('{{ w.username }}', '{{ w.pack_id }}', '{{ w.work_id }}', '{{ tip }}', this); return false;">
                                            {{ code }}
                                        </a>
                                    {% endfor %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="text-center mt-5 text-muted">No works found for selected student and statuses.</div>
        {% endif %}

        <!-- Done Packs Section -->
        {% if done_packs and done_packs|length > 0 and selected_student %}
        <div class="card shadow p-3 mt-4">
            <h5 class="card-title">Completed Packs for {{ selected_student }}</h5>
            <ul class="list-group list-group-flush">
                {% for done_pack in done_packs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>Pack {{ done_pack.pack_id }}: {{ done_pack.pack_desc }}</span>
                    <a href="javascript:void(0);" class="btn btn-sm btn-outline-warning"
                       onclick="restorePack('{{ selected_student }}', {{ done_pack.pack_id }})"
                       title="Restore Pack">
                       Restore
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function updateWorkStatus(username, pack_id, work_id, status, btn) {
        fetch('/update_work_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, pack_id, work_id, status })
        }).then(res => res.json())
          .then(data => {
              if(data.success) {
                  location.reload();
              } else {
                  alert(data.message || "Error updating status");
              }
          });
    }

    function markPackDone(username, packId) {
        fetch('/mark_pack_done', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username, pack_id: packId })
        }).then(res => res.json())
          .then(data => {
              if(data.success) {
                  location.reload(); // Refresh to hide the completed pack
              } else {
                  alert(data.message || "Error marking pack as done");
              }
          })
          .catch(err => {
              alert("Error: " + err.message);
          });
    }

    function restorePack(username, packId) {
        fetch('/restore_pack', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username, pack_id: packId })
        }).then(res => res.json())
          .then(data => {
              if(data.success) {
                  location.reload(); // Refresh to show the restored pack
              } else {
                  alert(data.message || "Error restoring pack");
              }
          })
          .catch(err => {
              alert("Error: " + err.message);
          });
    }

    document.querySelector('select[name="student"]').addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
    document.querySelectorAll('input[name="status"]').forEach(function(el) {
        el.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });
    </script>
</body>
</html>